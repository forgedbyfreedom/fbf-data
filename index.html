<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>Forged by Freedom — Live Sims (SU / ATS / O/U)</title>
<script src="https://cdn.tailwindcss.com"></script>
<style>
  body { background:#0f172a; color:#e2e8f0; }
  .badge { padding:.15rem .45rem; border-radius:.5rem; font-weight:600; }
  .fav { background:rgba(34,197,94,.18); color:#86efac; border:1px solid #22c55e44; }
  .dog { background:rgba(239,68,68,.18); color:#fca5a5; border:1px solid #ef444444; }
  .lean { background:rgba(59,130,246,.18); color:#93c5fd; border:1px solid #3b82f644; }
  .hdr { font-size:1.25rem; font-weight:700; color:#facc15; padding:1rem 0 .5rem; border-bottom:1px solid #475569; margin-top:1.5rem; }
</style>
</head>

<body class="min-h-screen px-4 py-6">
  <div class="max-w-6xl mx-auto">
    <h1 class="text-3xl font-bold text-center mb-2">Forged by Freedom — Live Simulation Dashboard</h1>
    <p id="status" class="text-center text-sm text-gray-400 mb-6">Loading…</p>
    <div id="container"></div>
    <footer class="text-center text-xs text-gray-500 mt-8">
      Results are probabilistic and informational only.
    </footer>
  </div>

<script>
/* ====== SIM SETTINGS ====== */
const N_SIM = 10000;        // sims per matchup
const TEAM_SD_POINTS = 13;  // per-team scoring SD
const DATA_PATH = "./combined.json"; // same folder as index.html

/* ====== RNG (normal) ====== */
function randn_bm(){
  let u=0,v=0; while(u===0)u=Math.random(); while(v===0)v=Math.random();
  return Math.sqrt(-2*Math.log(u))*Math.cos(2*Math.PI*v);
}
function rnorm(mean, sd){ return mean + randn_bm()*sd; }

/* ====== One-game Monte Carlo using favorite spread ======
   total = market total; spreadAbs = favorite's spread magnitude (always positive)
   We model favorite and dog means from total/spread:
   favMean = total/2 + spreadAbs/2
   dogMean = total/2 - spreadAbs/2
*/
function simulate(total, spreadAbs, n=N_SIM, sd=TEAM_SD_POINTS){
  let favSU=0, dogSU=0, favATS=0, dogATS=0, over=0, under=0;
  for(let i=0;i<n;i++){
    const favScore = rnorm(total/2 + spreadAbs/2, sd);
    const dogScore = rnorm(total/2 - spreadAbs/2, sd);

    if (favScore > dogScore) favSU++; else dogSU++;

    // ATS: favorite line is -spreadAbs
    const margin = favScore - dogScore;       // + means fav wins by X
    if (margin > -(-spreadAbs)) favATS++;     // beats -spreadAbs
    else dogATS++;

    const sum = favScore + dogScore;
    if (sum > total) over++; else under++;
  }
  return {
    favSU: favSU/n*100, dogSU: dogSU/n*100,
    favATS: favATS/n*100, dogATS: dogATS/n*100,
    over: over/n*100, under: under/n*100
  };
}

async function loadData(){
  const status = document.getElementById("status");
  const container = document.getElementById("container");
  try{
    status.textContent = "Fetching local combined.json and running 10k sims per game…";
    const res = await fetch(DATA_PATH, { cache:"no-cache" });
    if(!res.ok) throw new Error("HTTP "+res.status);
    const json = await res.json();
    const rows = (json.data ?? json);

    // Group by sport, with football first
    const title = {
      americanfootball_nfl:  "NFL Football",
      americanfootball_ncaaf:"NCAA Football",
      basketball_ncaab:      "NCAA Men’s Basketball",
      basketball_ncaaw:      "NCAA Women’s Basketball",
      baseball_mlb:          "MLB Baseball",
      icehockey_nhl:         "NHL Hockey",
      mma_mixedmartialarts:  "UFC / MMA"
    };
    const order = [
      "americanfootball_nfl",
      "americanfootball_ncaaf",
      "basketball_ncaab",
      "basketball_ncaaw",
      "baseball_mlb",
      "icehockey_nhl",
      "mma_mixedmartialarts"
    ];

    const bySport = {};
    rows.forEach(r=>{
      const k = r.sport_key || "other";
      (bySport[k] ||= []).push(r);
    });

    container.innerHTML = "";

    order.forEach(sport=>{
      const games = bySport[sport];
      if (!games || games.length===0) return;

      // Section scaffold
      const sec = document.createElement("section");
      sec.innerHTML = `
        <div class="hdr">${title[sport] || sport}</div>
        <div class="overflow-x-auto shadow-lg rounded-lg mb-8">
          <table class="min-w-full border border-gray-700 text-xs sm:text-sm">
            <thead class="bg-gray-800 text-gray-200">
              <tr>
                <th class="px-3 py-2 text-left">Matchup</th>
                <th class="px-3 py-2 text-left">Favorite (Spread)</th>
                <th class="px-3 py-2 text-left">Underdog</th>
                <th class="px-3 py-2 text-right">Total</th>
                <th class="px-3 py-2 text-left">Straight Up</th>
                <th class="px-3 py-2 text-left">ATS</th>
                <th class="px-3 py-2 text-left">O/U</th>
                <th class="px-3 py-2 text-right">Kickoff</th>
              </tr>
            </thead>
            <tbody class="divide-y divide-gray-700 bg-gray-900"></tbody>
          </table>
        </div>`;
      container.appendChild(sec);
      const tbody = sec.querySelector("tbody");

      // Sort by kickoff
      games.sort((a,b)=> new Date(a.commence_time) - new Date(b.commence_time));

      games.forEach(r=>{
        const [A,B] = (r.matchup||"").split("@").map(s=>s.trim());
        if (!A || !B) return;

        // Favorite & dog by ability (lower decimal ML is favored)
        const favTeam = (r.ml_fav < r.ml_dog) ? A : B;
        const dogTeam = (r.ml_fav < r.ml_dog) ? B : A;

        // Favorite spread: always show as negative next to favorite name
        const spreadAbs = Math.abs(Number(r.spread ?? 0)) || 0; // treat missing as 0
        const total = Number(r.total ?? 0) || 0;

        // Run sims only when we have both spread & total
        let suPick="—", suConf=0, atsPick="—", atsConf=0, ouPick="—", ouConf=0;
        if (spreadAbs > 0 && total > 0){
          const s = simulate(total, spreadAbs);
          suPick  = (s.favSU >= s.dogSU) ? favTeam : dogTeam;
          suConf  = Math.max(s.favSU, s.dogSU);

          atsPick = (s.favATS >= s.dogATS) ? `${favTeam} (-${spreadAbs.toFixed(1)})`
                                           : `${dogTeam} (+${spreadAbs.toFixed(1)})`;
          atsConf = Math.max(s.favATS, s.dogATS);

          ouPick  = (s.over >= s.under) ? "Over" : "Under";
          ouConf  = Math.max(s.over, s.under);
        }

        const tr = document.createElement("tr");
        tr.innerHTML = `
          <td class="px-3 py-2">${A} @ ${B}</td>
          <td class="px-3 py-2">
            <span class="badge fav">${favTeam} (${spreadAbs ? "−"+spreadAbs.toFixed(1) : "−0.0"})</span>
          </td>
          <td class="px-3 py-2"><span class="badge dog">${dogTeam}</span></td>
          <td class="px-3 py-2 text-right">${total ? total.toFixed(1) : ""}</td>
          <td class="px-3 py-2">
            <span class="badge lean">${suPick}</span>
            ${suConf ? `<span class="ml-2 text-xs text-gray-300">${suConf.toFixed(1)}%</span>` : ""}
          </td>
          <td class="px-3 py-2">
            <span class="badge lean">${atsPick}</span>
            ${atsConf ? `<span class="ml-2 text-xs text-gray-300">${atsConf.toFixed(1)}%</span>` : ""}
          </td>
          <td class="px-3 py-2">
            <span class="badge lean">${ouPick}</span>
            ${ouConf ? `<span class="ml-2 text-xs text-gray-300">${ouConf.toFixed(1)}%</span>` : ""}
          </td>
          <td class="px-3 py-2 text-right">${new Date(r.commence_time).toLocaleString()}</td>
        `;
        tbody.appendChild(tr);
      });
    });

    status.textContent = "Data loaded successfully.";
  }catch(err){
    console.error(err);
    document.getElementById("status").textContent = "⚠️ " + err.message;
  }
}

window.onload = loadData;
</script>
</body>
</html>
