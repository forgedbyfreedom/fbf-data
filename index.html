<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Forged by Freedom ‚Äî Sports Intelligence Dashboard</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    body { background:#0f0f0f; color:#fefefe; font-family: Inter, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, sans-serif; }
    .divider { border-bottom:4px solid #d4af37; width:140px; margin:.5rem auto 1.5rem; }
    .section-header { background:#1a1a1a; color:#d4af37; font-weight:700; padding:.5rem 1rem; border-radius:.5rem; text-transform:uppercase; letter-spacing:1px; margin-top:2rem; }
    .fav { color:#22c55e; font-weight:800; }
    .pick { font-weight:600; }
    .conf-high { color:#22c55e; }
    .conf-med { color:#eab308; }
    .conf-low { color:#ef4444; }
    .muted { color:#9ca3af; }
    a { color:#d4af37; }
  </style>
</head>
<body class="min-h-screen flex flex-col items-center py-10 px-4">

  <!-- HEADER -->
  <header class="text-center mb-8">
    <h1 class="text-4xl font-extrabold text-gray-100 mb-2 uppercase tracking-wide">
      Forged by Freedom ‚Äî Sports Intelligence Dashboard
    </h1>
    <div class="divider"></div>
    <div class="text-lg text-gray-300 font-medium italic">
      <p>Forged by Freedom Strength and Nutrition</p>
      <p class="text-sm text-gray-400">Strength ‚Ä¢ Discipline ‚Ä¢ Freedom</p>
      <p class="text-sm font-semibold text-gray-300 mt-1">We make your fitness goals realities!</p>
    </div>
  </header>

  <main class="w-full max-w-7xl bg-[#1b1b1b] shadow-2xl rounded-2xl p-6 border border-gray-800">
    <div class="flex items-end justify-between mb-4">
      <h2 class="text-xl font-semibold text-gray-200">Live Game Odds & Picks</h2>
      <div id="timestamp" class="text-right text-sm text-gray-400"></div>
    </div>
    <div id="contentArea" class="space-y-10"></div>
  </main>

  <footer class="mt-10 text-gray-500 text-xs">
    <p>&copy; 2025 Forged by Freedom. All rights reserved.</p>
  </footer>

  <script>
    const SPORT_NAMES = {
      "americanfootball_nfl": "üèà NFL Football",
      "americanfootball_ncaaf": "üéì NCAA Football",
      "basketball_ncaab": "üèÄ NCAA Men's Basketball",
      "basketball_ncaaw": "üèÄ NCAA Women's Basketball",
      "baseball_mlb": "‚öæ MLB Baseball",
      "icehockey_nhl": "üèí NHL Hockey",
      "mma_mixedmartialarts": "ü•ä UFC / MMA"
    };

    function confClass(v){
      const n = +v;
      if(n >= 80) return 'conf-high';
      if(n >= 60) return 'conf-med';
      return 'conf-low';
    }

    // Compute favorite & proper negative favorite spread, robust across feeds
    function resolveFavorite(game){
      // Prefer explicit team fields if present
      let away = game.away_team, home = game.home_team;
      if(!away || !home){
        const parts = (game.matchup || "").split("@");
        if(parts.length === 2){ away = parts[0].trim(); home = parts[1].trim(); }
      }

      // ESPN feed: home_spread/away_spread present ‚áí unambiguous
      if(typeof game.home_spread === 'number' || typeof game.away_spread === 'number'){
        if(typeof game.home_spread === 'number' && game.home_spread < 0){
          return { favorite: home, dog: away, favSpread: game.home_spread, away, home };
        }
        if(typeof game.away_spread === 'number' && game.away_spread < 0){
          return { favorite: away, dog: home, favSpread: game.away_spread, away, home };
        }
        // If neither is negative but one is defined, pick the more negative (or smaller) as fallback
        const hs = typeof game.home_spread === 'number' ? game.home_spread : Infinity;
        const as = typeof game.away_spread === 'number' ? game.away_spread : Infinity;
        if(Math.abs(hs) >= Math.abs(as)){
          return { favorite: away, dog: home, favSpread: as, away, home };
        }
        return { favorite: home, dog: away, favSpread: hs, away, home };
      }

      // Legacy feed: only single "spread" exists. We must decide who it belongs to.
      let spread = (typeof game.spread === 'number') ? game.spread : null;

      // If moneylines exist, use them to name the favorite (shorter ML ‚áí fave)
      // Note: ml_fav/ml_dog are prices; we only know which is shorter. We map that to a team by
      // comparing which mapping makes the spread negative for the favorite.
      const hasML = typeof game.ml_fav === 'number' && typeof game.ml_dog === 'number';
      if(hasML && spread !== null){
        // try home as favorite first if that produces negative fav spread
        // we force favorite's display spread negative regardless of input sign
        // then pick the mapping that keeps dog/fav consistent with market
        // Without per-team ML, we present favorite = team that yields negative display
        // Prefer mapping where display neg spread magnitude matches |spread|
        // Option A: home favorite
        const optA = { favorite: home, dog: away, favSpread: -Math.abs(spread), away, home };
        // Option B: away favorite
        const optB = { favorite: away, dog: home, favSpread: -Math.abs(spread), away, home };
        // We can‚Äôt tell which ML belongs to which team, but either mapping shows
        // a negative number for the favorite and positive for the dog.
        // If you later add per-team MLs, replace with exact mapping.
        return optA; // default home as favorite in ambiguous legacy case
      }

      // No MLs: last resort‚Äîassume the team that makes the favorite spread negative.
      if(spread !== null){
        // Choose the mapping that yields a negative favorite spread
        // Use home by default (safer with most books), but you can flip by rule if needed
        return { favorite: (spread < 0 ? home : away), dog: (spread < 0 ? away : home), favSpread: -Math.abs(spread), away, home };
      }

      // If we still can't resolve, fall back to matchup ordering
      return { favorite: home || 'N/A', dog: away || 'N/A', favSpread: null, away, home };
    }

    // Simple, transparent confidence models (replace with your model when ready)
    function suConfidence(game){
      // lower favorite ML ‚áí higher SU confidence; if missing, base on spread magnitude
      if(typeof game.ml_fav === 'number'){
        const base = 100 - Math.max(0, (game.ml_fav - 1) * 10);
        return Math.max(50, Math.min(97, base)).toFixed(1);
      }
      if(typeof game.home_spread === 'number' || typeof game.away_spread === 'number' || typeof game.spread === 'number'){
        const mag = Math.abs(game.home_spread ?? game.away_spread ?? game.spread ?? 0);
        const base = 55 + Math.min(35, mag * 5);
        return Math.max(55, Math.min(95, base)).toFixed(1);
      }
      return "60.0";
    }

    function atsConfidence(game){
      const s = Math.abs(game.home_spread ?? game.away_spread ?? game.spread ?? 0);
      const base = 55 + Math.max(0, 15 - Math.min(15, s * 3)); // smaller lines ‚Üí closer; cap mid-70s/low-80s
      return Math.max(55, Math.min(85, base)).toFixed(1);
    }

    function ouConfidence(game){
      const total = Number(game.total);
      if(!isFinite(total)) return "60.0";
      const dev = Math.abs(total - 45);
      const base = 60 + Math.min(25, dev * 1.2);
      return Math.max(60, Math.min(90, base)).toFixed(1);
    }

    function buildRow(game){
      const r = resolveFavorite(game);
      const fav = r.favorite || '';
      const dog = r.dog || '';
      // Ensure favorite spread is negative for display
      let favSpread = (typeof r.favSpread === 'number') ? -Math.abs(r.favSpread) : null;
      const favSpreadTxt = (favSpread !== null) ? `(${favSpread.toFixed(1)})` : `(n/a)`;

      // Picks
      const su_conf = suConfidence(game);
      const ats_conf = atsConfidence(game);
      const ou_conf = ouConfidence(game);

      // ATS: if |line| ‚â§ 3 ‚Üí take +points (dog); else lay points with favorite
      const rawS = Math.abs(game.home_spread ?? game.away_spread ?? game.spread ?? 0);
      const ats_pick = (rawS <= 3)
        ? `${dog} +${rawS.toFixed(1)}`
        : `${fav} ${(-Math.abs(rawS)).toFixed(1)}`;

      const ou_pick = (Number(game.total) > 46)
        ? `Over ${Number(game.total).toFixed(1)}`
        : `Under ${Number(game.total).toFixed(1)}`;

      return `
        <tr>
          <td class="px-3 py-2">${(r.away||'').trim()} @ ${(r.home||'').trim()}</td>
          <td class="px-3 py-2 text-right fav">${fav} ${favSpreadTxt}</td>
          <td class="px-3 py-2 text-right pick ${confClass(su_conf)}">${fav} (${su_conf}%)</td>
          <td class="px-3 py-2 text-right pick ${confClass(ats_conf)}">${ats_pick} (${ats_conf}%)</td>
          <td class="px-3 py-2 text-right pick ${confClass(ou_conf)}">${ou_pick} (${ou_conf}%)</td>
        </tr>
      `;
    }

    async function loadData(){
      const url = "https://cdn.jsdelivr.net/gh/forgedbyfreedom/fbf-data@main/combined.json?cachebust=" + Date.now();
      const content = document.getElementById("contentArea");
      const timestampDiv = document.getElementById("timestamp");

      try{
        const res = await fetch(url);
        if(!res.ok) throw new Error(res.statusText);
        const json = await res.json();
        const data = json.data || [];
        timestampDiv.textContent = `Last updated: ${json.timestamp || 'Unknown'}`;

        const now = new Date();
        const in8 = new Date(now); in8.setDate(now.getDate()+8);

        let filtered = data.filter(g => {
          const t = new Date(g.commence_time);
          return isFinite(t) && t >= now && t <= in8;
        });
        if(filtered.length === 0 && data.length > 0) filtered = data;

        // group by sport
        const grouped = {};
        for(const g of filtered){
          const k = g.sport_key || 'other';
          (grouped[k] ||= []).push(g);
        }

        content.innerHTML = "";
        const sportOrder = [
          "americanfootball_nfl",
          "americanfootball_ncaaf",
          "basketball_ncaab",
          "basketball_ncaaw",
          "baseball_mlb",
          "icehockey_nhl",
          "mma_mixedmartialarts"
        ];

        for(const key of sportOrder){
          const games = grouped[key];
          if(!games || !games.length) continue;

          // sort by commence time then by absolute spread
          games.sort((a,b)=>{
            const ta = new Date(a.commence_time).getTime() || 0;
            const tb = new Date(b.commence_time).getTime() || 0;
            if(ta !== tb) return ta - tb;
            const sa = Math.abs(a.home_spread ?? a.away_spread ?? a.spread ?? 0);
            const sb = Math.abs(b.home_spread ?? b.away_spread ?? b.spread ?? 0);
            return sa - sb;
          });

          const section = document.createElement("div");
          section.innerHTML = `
            <h3 class="section-header">${SPORT_NAMES[key] || key}</h3>
            <div class="overflow-x-auto mt-3">
              <table class="min-w-full border border-gray-700 divide-y divide-gray-700 text-sm">
                <thead class="bg-[#2a2a2a] text-gray-200">
                  <tr>
                    <th class="px-3 py-2 text-left">Matchup</th>
                    <th class="px-3 py-2 text-right">Favorite (Spread)</th>
                    <th class="px-3 py-2 text-right">Straight Up Pick</th>
                    <th class="px-3 py-2 text-right">ATS Pick</th>
                    <th class="px-3 py-2 text-right">O/U Pick</th>
                  </tr>
                </thead>
                <tbody class="divide-y divide-gray-800">
                  ${games.map(buildRow).join("")}
                </tbody>
              </table>
              <p class="mt-2 text-xs muted">Favorite is ALWAYS shown with a negative spread. Data sources merged; if a legacy row lacks team-level spreads, we force the favorite‚Äôs spread negative for clarity.</p>
            </div>
          `;
          content.appendChild(section);
        }

        if(!content.children.length){
          content.innerHTML = `<p class="text-gray-400 text-center">No current games available.</p>`;
        }
      }catch(err){
        console.error(err);
        content.innerHTML = `<p class="text-red-500 text-center mt-10">‚ö†Ô∏è Error loading data (check JSON source)</p>`;
      }
    }

    loadData();
  </script>
</body>
</html>
