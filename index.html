<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>FBF Data Board</title>

  <!-- stops favicon 404 -->
  <link rel="icon" href="data:," />

  <style>
    :root {
      --bg: #0b0e14;
      --panel: #121726;
      --panel-2: #0f1422;
      --text: #e6e9ef;
      --muted: #9aa4b2;
      --accent: #6aa6ff;
      --good: #35d49a;
      --bad: #ff6b6b;
      --warn: #f6c453;
      --border: #1f2940;
    }
    * { box-sizing: border-box; }
    body {
      margin: 0; font-family: system-ui, -apple-system, Segoe UI, Roboto, sans-serif;
      background: var(--bg); color: var(--text);
    }
    header {
      padding: 18px 20px; border-bottom: 1px solid var(--border);
      display:flex; gap:12px; align-items:center; justify-content:space-between;
      position: sticky; top:0; background: rgba(11,14,20,0.95); backdrop-filter: blur(6px);
      z-index: 5;
    }
    h1 { margin:0; font-size: 20px; letter-spacing: .4px; }
    .sub { color: var(--muted); font-size: 12px; }

    .wrap { padding: 16px; max-width: 1200px; margin: 0 auto; }

    .tabs { display:flex; flex-wrap: wrap; gap:8px; margin-bottom:12px; }
    .tab {
      padding: 8px 10px; background: var(--panel); border:1px solid var(--border);
      border-radius: 10px; cursor:pointer; font-size: 13px; color: var(--muted);
      user-select: none;
    }
    .tab.active { color: var(--text); border-color: var(--accent); box-shadow: 0 0 0 1px rgba(106,166,255,.2) inset; }

    .grid { display:grid; grid-template-columns: repeat(auto-fill,minmax(320px,1fr)); gap:12px; }

    .card {
      background: var(--panel); border:1px solid var(--border); border-radius: 14px;
      padding: 12px; display:flex; flex-direction:column; gap:8px;
    }
    .row { display:flex; align-items:center; justify-content:space-between; gap:8px; }
    .teams { display:grid; gap:6px; }
    .teamline { display:flex; align-items:center; gap:8px; }
    .logo { width:22px; height:22px; border-radius:4px; background: var(--panel-2); object-fit:cover; }
    .abbr { font-weight:700; letter-spacing:.6px; }
    .score { font-size: 18px; font-weight:800; }
    .muted { color: var(--muted); font-size: 12px; }

    .pill { font-size:11px; padding:2px 6px; border-radius:999px; background: var(--panel-2); border:1px solid var(--border); color: var(--muted); }
    .pill.good { color: var(--good); border-color: rgba(53,212,154,.4); }
    .pill.bad { color: var(--bad); border-color: rgba(255,107,107,.4); }
    .pill.warn { color: var(--warn); border-color: rgba(246,196,83,.4); }

    .sectionTitle { margin: 14px 2px 8px; font-size: 14px; color: var(--muted); text-transform: uppercase; letter-spacing: 1px; }

    .empty {
      padding: 18px; background: var(--panel); border:1px dashed var(--border);
      border-radius: 12px; color: var(--muted); text-align:center;
    }

    footer { padding:16px; color:var(--muted); font-size:12px; text-align:center; }
    a { color: var(--accent); text-decoration: none; }
  </style>
</head>
<body>
  <header>
    <div>
      <h1>Forged By Freedom ‚Äî Data Board</h1>
      <div class="sub" id="lastUpdated">Loading‚Ä¶</div>
    </div>
    <div class="sub">
      <span class="pill">combined.json</span>
      <span class="pill">predictions.json</span>
      <span class="pill">weather.json</span>
      <span class="pill">referee_trends.json</span>
    </div>
  </header>

  <div class="wrap">
    <div class="tabs" id="tabs"></div>

    <div id="content"></div>

    <div class="sectionTitle">Referee Trends (optional)</div>
    <div id="refs" class="empty">No referee trends loaded yet.</div>
  </div>

  <footer>
    Data source: ESPN Core API. ¬© FBF
  </footer>

<script>
const FILES = {
  combined: "combined.json",
  predictions: "predictions.json",
  weather: "weather.json",
  injuries: "injuries.json",
  referees: "referee_trends.json"
};

async function safeFetchJSON(url) {
  try {
    const r = await fetch(url, { cache: "no-store" });
    if (!r.ok) return null;
    return await r.json();
  } catch (e) { return null; }
}

function groupBySport(games) {
  const out = {};
  for (const g of games) {
    const k = g.sport || "other";
    if (!out[k]) out[k] = [];
    out[k].push(g);
  }
  return out;
}

function sportLabel(k) {
  return ({
    nfl:"NFL",
    ncaaf:"NCAAF",
    nba:"NBA",
    ncaab:"NCAAB",
    ncaaw:"NCAAW",
    nhl:"NHL",
    mlb:"MLB",
    arts:"UFC"
  })[k] || k.toUpperCase();
}

function cardHTML(g, predsById) {
  const home = g.home_team || {};
  const away = g.away_team || {};
  const p = predsById[g.id];

  const hs = g.home_score ?? "";
  const as = g.away_score ?? "";

  const isFinal = g.completed;
  const state = g.state || (isFinal ? "final" : "scheduled");
  const statePill = isFinal ? "good" : "pill";

  const odds = g.odds || {};
  const spread = odds.spread != null ? (odds.fav_side === "away" ? `Away -${odds.spread}` : `Home -${odds.spread}`) : null;
  const total = odds.total != null ? `O/U ${odds.total}` : null;

  const venue = g.venue || {};
  const venueLine = venue.name ? `${venue.name}${venue.city ? " ‚Ä¢ "+venue.city : ""}${venue.state ? ", "+venue.state : ""}` : null;

  const officials = (g.officials || []).slice(0,3).map(o => `${o.name}${o.role ? " ("+o.role+")" : ""}`).join(", ");

  return `
  <div class="card">
    <div class="row">
      <div class="muted">${g.date_local || g.date_utc || ""}</div>
      <div class="pill ${statePill}">${state}</div>
    </div>

    <div class="teams">
      <div class="teamline">
        <img class="logo" src="${away.logo || ""}" onerror="this.style.display='none'">
        <div class="abbr">${away.abbr || away.name || "Away"}</div>
        <div class="score">${as}</div>
      </div>
      <div class="teamline">
        <img class="logo" src="${home.logo || ""}" onerror="this.style.display='none'">
        <div class="abbr">${home.abbr || home.name || "Home"}</div>
        <div class="score">${hs}</div>
      </div>
    </div>

    ${p ? `
      <div class="row">
        <div class="muted">Model Pick</div>
        <div class="pill warn">${p.pick || "‚Äî"} ${p.edge != null ? `(${p.edge.toFixed(2)}%)` : ""}</div>
      </div>
    ` : ""}

    ${(spread || total) ? `
      <div class="row">
        <div class="muted">Odds</div>
        <div style="display:flex; gap:6px; flex-wrap:wrap;">
          ${spread ? `<span class="pill">${spread}</span>` : ""}
          ${total ? `<span class="pill">${total}</span>` : ""}
        </div>
      </div>
    ` : ""}

    ${venueLine ? `<div class="muted">üìç ${venueLine}</div>` : ""}
    ${officials ? `<div class="muted">üë®‚Äç‚öñÔ∏è ${officials}</div>` : ""}
  </div>`;
}

function renderTabs(keys, activeKey) {
  const tabs = document.getElementById("tabs");
  tabs.innerHTML = "";
  keys.forEach(k => {
    const el = document.createElement("div");
    el.className = "tab" + (k === activeKey ? " active" : "");
    el.textContent = sportLabel(k);
    el.onclick = () => { window.location.hash = k; render(activeKey = k); };
    tabs.appendChild(el);
  });
}

let cached = null;

async function render(activeKey=null) {
  if (!cached) {
    const [combined, predictions, refs] = await Promise.all([
      safeFetchJSON(FILES.combined),
      safeFetchJSON(FILES.predictions),
      safeFetchJSON(FILES.referees)
    ]);

    cached = { combined, predictions, refs };
  }

  const combined = cached.combined;
  const preds = cached.predictions;
  const refs = cached.refs;

  const games = combined?.data || [];
  const updated = combined?.timestamp || "unknown";

  document.getElementById("lastUpdated").textContent =
    `Last updated: ${updated} UTC ‚Ä¢ Games: ${games.length}`;

  // predictions index
  const predsById = {};
  if (preds?.data) {
    for (const p of preds.data) predsById[p.id] = p;
  }

  const bySport = groupBySport(games);
  const sportKeys = Object.keys(bySport).sort();

  if (!activeKey) activeKey = window.location.hash.replace("#","") || sportKeys[0] || "nfl";
  if (!sportKeys.includes(activeKey)) activeKey = sportKeys[0];

  renderTabs(sportKeys.length ? sportKeys : ["nfl","ncaaf","nba","ncaab","nhl","mlb","arts"], activeKey);

  const content = document.getElementById("content");
  const activeGames = bySport[activeKey] || [];

  if (!activeGames.length) {
    content.innerHTML = `<div class="empty">No games found for ${sportLabel(activeKey)} in the next 7 on-days.</div>`;
  } else {
    content.innerHTML = `<div class="grid">${
      activeGames.map(g => cardHTML(g, predsById)).join("")
    }</div>`;
  }

  // refs section
  const refsEl = document.getElementById("refs");
  if (refs?.officials?.length) {
    const top = refs.officials.slice(0,10);
    refsEl.className = "";
    refsEl.innerHTML = `
      <div class="grid">
        ${top.map(o => `
          <div class="card">
            <div class="row">
              <div><strong>${o.name}</strong></div>
              <div class="pill">${o.games_seen} games</div>
            </div>
            <div class="muted">PPG penalties: ${o.penalties_per_game}</div>
            <div class="muted">Home bias: ${o.home_penalty_bias_pct}%</div>
            ${o.over_rate != null ? `<div class="muted">Over rate: ${o.over_rate}%</div>` : ""}
          </div>
        `).join("")}
      </div>`;
  } else {
    refsEl.className = "empty";
    refsEl.textContent = "No referee trends loaded yet.";
  }
}

render();
window.addEventListener("hashchange", () => render());
</script>
</body>
</html>
