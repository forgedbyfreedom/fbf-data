<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Forged By Freedom — Live Odds & Picks</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <style>
    :root {
      --bg: #05070b;
      --card-bg: #0c1018;
      --card-bg-alt: #0f141e;
      --accent: #ff7a1a;
      --accent-soft: #ffb266;
      --text: #f5f7ff;
      --muted: #9ba3b8;
      --border-soft: #252b3a;
      --danger: #ff4b5c;
      --warning: #facc15;
      --success: #22c55e;
      --chip-bg: #151a24;
      --chip-active-bg: #ff7a1a;
      --chip-active-text: #05070b;
      --badge-bg: #111827;
    }

    body {
      margin: 0;
      padding: 12px;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      background: radial-gradient(circle at top left, #111827, #020308 55%) fixed;
      color: var(--text);
    }
    #app { max-width: 1400px; margin: 0 auto; }

    header {
      display: flex; flex-direction: column; align-items: center;
      gap: 14px; margin-bottom: 18px; padding: 18px 10px;
      background: rgba(12,16,24,0.9);
      border: 1px solid var(--border-soft); border-radius: 14px;
      box-shadow: 0 8px 28px rgba(0,0,0,0.5);
      position: sticky; top: 8px; z-index: 5; backdrop-filter: blur(6px);
      text-align: center;
    }
    .brand-block { display:flex; flex-direction:column; align-items:center; gap:4px; }
    .brand-title {
      font-size:34px; font-weight:900; color:var(--accent); letter-spacing:1.3px;
      text-shadow:0 0 6px #ff7a1a, 0 0 12px #ff7a1a; animation:pulseGlow 2.2s ease-in-out infinite;
    }
    @keyframes pulseGlow {
      0%{text-shadow:0 0 4px #ff7a1a,0 0 8px #ff7a1a;}
      50%{text-shadow:0 0 12px #ffb266,0 0 24px #ff7a1a;}
      100%{text-shadow:0 0 4px #ff7a1a,0 0 8px #ff7a1a;}
    }
    .brand-sub { font-size:13px; letter-spacing:1px; color:var(--muted); font-weight:600; }
    .brand-url { font-size:11px; letter-spacing:2px; color:var(--accent-soft); font-weight:700; }

    .controls { display:flex; flex-wrap:wrap; gap:8px; justify-content:center; }
    .chip {
      background:var(--chip-bg); border:1px solid var(--border-soft);
      color:var(--text); padding:6px 12px; border-radius:999px;
      font-size:13px; cursor:pointer; user-select:none; transition:120ms ease;
    }
    .chip.active {
      background:var(--chip-active-bg); color:var(--chip-active-text);
      border-color:transparent; font-weight:700;
      box-shadow:0 0 0 2px rgba(255,122,26,0.15);
    }

    .statusline { font-size:11px; color:var(--muted); display:flex; flex-direction:column; gap:2px; }

    .cards-grid {
      display:grid; grid-template-columns:repeat(3,minmax(0,1fr));
      gap:14px; width:100%; margin-top:10px;
    }
    @media (max-width:1000px){ .cards-grid{grid-template-columns:repeat(2,minmax(0,1fr));}}
    @media (max-width:640px){ .cards-grid{grid-template-columns:1fr;}}

    .game-card {
      background: radial-gradient(circle at top left, var(--card-bg-alt), var(--card-bg));
      border-radius: 14px; border: 1px solid var(--border-soft);
      padding: 10px; box-shadow: 0 10px 30px rgba(0,0,0,0.6);
      display:flex; flex-direction:column; gap:8px; min-height:175px;
    }
    .row { display:flex; justify-content:space-between; align-items:center; gap:8px; }
    .muted { color: var(--muted); }
    .badge {
      background: var(--badge-bg); border:1px solid var(--border-soft);
      padding:2px 7px; border-radius:8px; font-size:11px; letter-spacing:0.3px;
    }
    .team { font-size:16px; font-weight:800; }
    .team.away { color:#cbd5e1; }
    .team.home { color:#fff; }

    .pickbox {
      background:#0b1220; border:1px dashed var(--border-soft);
      border-radius:10px; padding:6px 8px; font-size:12px;
      display:flex; flex-direction:column; gap:3px;
    }
    .pickline { display:flex; justify-content:space-between; gap:8px; }
    .conf { color:var(--accent-soft); font-weight:700; }

    .empty { margin-top:16px; text-align:center; color:var(--muted); }
  </style>
</head>

<body>
  <div id="app">
    <header>
      <div class="brand-block">
        <div class="brand-title">FORGED BY FREEDOM</div>
        <div class="brand-sub">Strength – Discipline – Freedom</div>
        <div class="brand-url">FORGEDBYFREEDOM.org</div>
      </div>

      <div class="controls" id="sport-filters"></div>

      <div class="statusline" id="statusline">
        <div>Loading…</div>
      </div>
    </header>

    <main class="cards-grid" id="cards-grid"></main>
    <div class="empty" id="empty" style="display:none;">No upcoming games found.</div>
  </div>

  <script>
    const CACHE_BUST = () => "?cb=" + Date.now();

    const SPORT_LABELS = {
      "americanfootball_nfl": "NFL",
      "americanfootball_ncaaf": "NCAAF",
      "basketball_nba": "NBA",
      "basketball_ncaab": "NCAAB",
      "icehockey_nhl": "NHL",
      "baseball_mlb": "MLB",
      "mma_mixed_martial_arts": "UFC"
    };

    let ACTIVE_SPORT = "ALL";
    let ALL_GAMES = [];

    function toDate(x){ try { return new Date(x); } catch { return null; } }
    function formatTime(iso){
      const d = toDate(iso);
      if(!d) return "—";
      return d.toLocaleString("en-US",{month:"short",day:"numeric",hour:"numeric",minute:"2-digit"});
    }

    async function loadJsonSafe(path){
      try{
        const r = await fetch(path + CACHE_BUST());
        if(!r.ok) throw new Error(path + " " + r.status);
        return await r.json();
      }catch(e){
        console.warn("missing/failed", path, e);
        return null;
      }
    }

    function buildIndexByIdOrMatchup(list){
      const byId = new Map();
      const byMatch = new Map();
      (list || []).forEach(x=>{
        if(x && x.event_id) byId.set(String(x.event_id), x);
        if(x && x.matchup) byMatch.set(String(x.matchup).toLowerCase(), x);
      });
      return { byId, byMatch };
    }

    function mergeGame(game, idx){
      const id = game.event_id ? String(game.event_id) : null;
      const m  = game.matchup ? String(game.matchup).toLowerCase() : null;

      const pick = (id && idx.picks.byId.get(id)) || (m && idx.picks.byMatch.get(m)) || null;
      const wx   = (id && idx.weather.byId.get(id)) || (m && idx.weather.byMatch.get(m)) || null;
      const ref  = (id && idx.refs.byId.get(id)) || (m && idx.refs.byMatch.get(m)) || null;
      const inj  = (id && idx.inj.byId.get(id)) || (m && idx.inj.byMatch.get(m)) || null;

      return { ...game, pick, wx, ref, inj };
    }

    function buildFilters(games){
      const el = document.getElementById("sport-filters");
      const sports = Array.from(new Set(games.map(g=>g.sport_key).filter(Boolean)));

      const mkChip = (key,label)=>{
        const c = document.createElement("div");
        c.className = "chip" + (ACTIVE_SPORT===key ? " active":"");
        c.textContent = label;
        c.onclick = ()=>{
          ACTIVE_SPORT = key;
          document.querySelectorAll(".chip").forEach(x=>x.classList.remove("active"));
          c.classList.add("active");
          render();
        };
        return c;
      };

      el.innerHTML = "";
      el.appendChild(mkChip("ALL","ALL"));
      sports.forEach(s=>{
        el.appendChild(mkChip(s, SPORT_LABELS[s] || s));
      });
    }

    function render(){
      const grid = document.getElementById("cards-grid");
      const empty = document.getElementById("empty");

      const games = ACTIVE_SPORT==="ALL"
        ? ALL_GAMES
        : ALL_GAMES.filter(g=>g.sport_key===ACTIVE_SPORT);

      grid.innerHTML = "";

      if(!games.length){
        empty.style.display = "block";
        return;
      }
      empty.style.display = "none";

      games.forEach(g=>{
        const card = document.createElement("div");
        card.className = "game-card";

        const top = document.createElement("div");
        top.className = "row";
        top.innerHTML = `
          <div class="badge">${SPORT_LABELS[g.sport_key] || g.sport_key || "—"}</div>
          <div class="muted">${formatTime(g.commence_time)}</div>
        `;

        const teams = document.createElement("div");
        teams.innerHTML = `
          <div class="team away">${g.away_team || "—"}</div>
          <div class="team home">${g.home_team || "—"}</div>
        `;

        const market = document.createElement("div");
        market.className = "muted";
        const fav = g.favorite || "—";
        const dog = g.underdog || "—";
        const total = (g.total!=null) ? g.total : "—";
        market.innerHTML = `
          <div>Fav: <b>${fav}</b></div>
          <div>Dog: ${dog}</div>
          <div>Total: ${total}</div>
          <div class="muted" style="font-size:11px;">Book: ${g.book || "—"}</div>
        `;

        const picks = document.createElement("div");
        picks.className = "pickbox";
        if(g.pick){
          picks.innerHTML = `
            <div class="pickline"><span>SU:</span><b>${g.pick.su_pick || "—"}</b><span class="conf">${g.pick.su_conf ?? ""}</span></div>
            <div class="pickline"><span>ATS:</span><b>${g.pick.ats_pick || "—"}</b><span class="conf">${g.pick.ats_conf ?? ""}</span></div>
            <div class="pickline"><span>O/U:</span><b>${g.pick.ou_pick || "—"}</b><span class="conf">${g.pick.ou_conf ?? ""}</span></div>
          `;
        } else {
          picks.innerHTML = `<div class="muted">No prediction file match yet.</div>`;
        }

        card.appendChild(top);
        card.appendChild(teams);
        card.appendChild(market);
        card.appendChild(picks);

        grid.appendChild(card);
      });
    }

    async function boot(){
      const status = document.getElementById("statusline");
      status.innerHTML = `<div>Loading data…</div>`;

      const [combined, predictions, weather, refs, injuries] = await Promise.all([
        loadJsonSafe("combined.json"),
        loadJsonSafe("predictions.json"),
        loadJsonSafe("weather.json"),
        loadJsonSafe("referee_trends.json"),  // <-- KEEP THIS NAME
        loadJsonSafe("injuries.json"),
      ]);

      const games = (combined && combined.data) ? combined.data : [];
      const picksList = (predictions && predictions.data) ? predictions.data : [];
      const wxList = (weather && weather.data) ? weather.data : [];
      const refList = (refs && (refs.data || refs.officials)) ? (refs.data || refs.officials) : [];
      const injList = (injuries && injuries.data) ? injuries.data : [];

      const idx = {
        picks: buildIndexByIdOrMatchup(picksList),
        weather: buildIndexByIdOrMatchup(wxList),
        refs: buildIndexByIdOrMatchup(refList),
        inj: buildIndexByIdOrMatchup(injList),
      };

      ALL_GAMES = games.map(g => mergeGame(g, idx));

      buildFilters(ALL_GAMES);
      render();

      const cTS = combined?.timestamp || "—";
      const pTS = predictions?.timestamp || "—";
      const wTS = weather?.timestamp || "—";
      const rTS = refs?.timestamp || "—";

      status.innerHTML = `
        <div>Odds: ${cTS}</div>
        <div>Picks: ${pTS}</div>
        <div>Weather: ${wTS}</div>
        <div>Refs: ${rTS}</div>
      `;
    }

    boot();
  </script>
</body>
</html>
