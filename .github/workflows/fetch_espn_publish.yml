name: Auto Fetch & Publish ESPN Odds

on:
  schedule:
    - cron: "*/15 * * * *"
  workflow_dispatch:

jobs:
  fetch-and-publish:
    runs-on: ubuntu-latest

    steps:
      #####################################################################
      # 1) CLEAN WORKSPACE ‚Äî SAFEST POSSIBLE VERSION
      #####################################################################
      - name: üß® Clean workspace
        run: |
          echo "üß® Cleaning workspace..."
          sudo rm -rf ./* || true
          sudo rm -rf ./.??* || true
          echo "Workspace cleaned."

      #####################################################################
      # 2) CLEAN CHECKOUT ‚Äî NO MORE fbf-data/fbf-data
      #####################################################################
      - name: üì• Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 1
          clean: true

      #####################################################################
      # 3) SET UP PYTHON
      #####################################################################
      - name: üêç Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: "3.11"

      #####################################################################
      # 4) INSTALL REQUIREMENTS
      #####################################################################
      - name: üì¶ Install Python dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      #####################################################################
      # 5) FETCH ESPN DATA
      #####################################################################
      - name: üì° Fetch ESPN odds‚Ä¶
        run: |
          echo "üì° Fetching ESPN odds..."
          python3 fetch_espn_all.py

      #####################################################################
      # 6) TAG FAVORITES
      #####################################################################
      - name: üè∑ Tag favorites
        run: python3 tag_favorites.py

      #####################################################################
      # 7) BUILD STADIUM FILES
      #####################################################################
      - name: üèü Build FBS Stadiums
        run: |
          python3 build_fbs_stadiums.py
          echo "Stadium files built."

      #####################################################################
      # 8) WEATHER PIPELINE
      #####################################################################
      - name: üå¶ Fetch Weather
        run: python3 fetch_weather.py

      - name: ‚ö° Compute Weather Risk
        run: python3 weather_risk1.py

      - name: üîó Merge Weather
        run: python3 merge_weather.py

      #####################################################################
      # 9) INJURY PIPELINE
      #####################################################################
      - name: ü©∫ Fetch Injuries (non-fatal)
        run: python3 fetch_injuries.py || echo "‚ö†Ô∏è Injury fetch failed ‚Äî continuing"

      - name: üîó Merge Injuries (non-fatal)
        run: python3 merge_injuries.py || echo "‚ö†Ô∏è Merge injuries failed ‚Äî continuing"

      #####################################################################
      # 10) HISTORICAL DATA + ML PREDICTIONS
      #####################################################################
      - name: üìö Build historical results
        run: python3 build_historical_results.py || echo "‚ö†Ô∏è No historical results"

      - name: ü§ñ Train ML model
        run: python3 train_model.py || echo "‚ö†Ô∏è ML training skipped"

      - name: üîÆ Build predictions
        run: python3 build_predictions.py

      #####################################################################
      # 11) PUSH BACK UPDATED DATA
      #####################################################################
      - name: üì§ Commit & Push updated data
        run: |
          git config --global user.name "GitHub Actions"
          git config --global user.email "actions@github.com"

          git add -A
          git commit -m "Auto update data $(date -u +"%Y-%m-%d %H:%M:%S") UTC" || echo "Nothing to commit"

          git pull --rebase --autostash || true
          git push || echo "Nothing to push"

      #####################################################################
      # 12) DONE
      #####################################################################
      - name: üßπ Cleanup
        run: echo "Done."
