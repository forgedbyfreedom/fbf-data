name: Auto Fetch & Publish ESPN Odds

on:
  schedule:
    - cron: "*/15 * * * *"
  workflow_dispatch:

jobs:
  fetch-and-publish:
    runs-on: ubuntu-latest

    steps:
      #####################################################################
      # 1) NUKE GITHUB WORKSPACE â€” GUARANTEED CLEAN, FIX NESTED PATHS
      #####################################################################
      - name: ðŸ”¥ Nuke GitHub Runner Workspace (Fix nested fbf-data/fbf-data)
        run: |
          echo "ðŸ”¥ FULL WORKSPACE NUKE"
          sudo rm -rf $GITHUB_WORKSPACE/*
          sudo rm -rf $GITHUB_WORKSPACE/.[!.]*
          sudo rm -rf $GITHUB_WORKSPACE/.??*
          echo "ðŸ”¥ Workspace nuked."

      #####################################################################
      # 2) CLEAN CHECKOUT
      #####################################################################
      - name: ðŸ“¥ Checkout repository (Fresh)
        uses: actions/checkout@v4
        with:
          fetch-depth: 1
          clean: true
          path: .

      #####################################################################
      # 3) SET UP PYTHON
      #####################################################################
      - name: ðŸ Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: "3.11"

      #####################################################################
      # 4) INSTALL REQUIREMENTS
      #####################################################################
      - name: ðŸ“¦ Install Python dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      #####################################################################
      # 5) FETCH ESPN DATA
      #####################################################################
      - name: ðŸ“¡ Fetch ESPN odds
        run: python3 fetch_espn_all.py

      #####################################################################
      # 6) TAG FAVORITES
      #####################################################################
      - name: ðŸ· Tag favorites
        run: python3 tag_favorites.py

      #####################################################################
      # 7) BUILD STADIUMS
      #####################################################################
      - name: ðŸŸ Build FBS Stadiums (correct, safe)
        run: python3 build_fbs_stadiums.py

      #####################################################################
      # 8) WEATHER FETCH + WEATHER RISK
      #####################################################################
      - name: ðŸŒ¦ Fetch Weather
        run: python3 fetch_weather.py

      - name: âš¡ Compute Weather Risk
        run: python3 weather_risk1.py

      #####################################################################
      # 9) MERGE WEATHER
      #####################################################################
      - name: ðŸ”— Merge Weather
        run: python3 merge_weather.py

      #####################################################################
      # 10) INJURIES
      #####################################################################
      - name: ðŸ©º Fetch Injuries
        run: python3 fetch_injuries.py || echo "âš ï¸ Injury fetch failed â€” continuing"

      - name: ðŸ”— Merge Injuries
        run: python3 merge_injuries.py || echo "âš ï¸ Merge injuries failed â€” continuing"

      #####################################################################
      # 11) HISTORICAL RESULTS + ML TRAINING + PREDICTIONS
      #####################################################################
      - name: ðŸ§® Build historical results
        run: python3 build_historical_results.py || echo "âš ï¸ No historical results"

      - name: ðŸ¤– Train ML model
        run: python3 train_model.py || echo "âš ï¸ ML Training skipped"

      - name: ðŸ”® Build predictions
        run: python3 build_predictions.py

      #####################################################################
      # 12) COMMIT & PUSH â€” ***SAFE FORCE PUSH, NEVER FAILS***
      #####################################################################
      - name: ðŸ“¤ Commit & Push updated data (safe, atomic)
        run: |
          git config --global user.name "GitHub Actions"
          git config --global user.email "actions@github.com"

          echo "ðŸ“¦ Staging changes..."
          git add -A

          # If no changes -> exit early
          if git diff --cached --quiet; then
            echo "No changes to commit."
            exit 0
          fi

          echo "ðŸ§¾ Committing..."
          git commit -m "Auto update data $(date -u +'%Y-%m-%d %H:%M:%S UTC')"

          echo "ðŸš€ Safe force-push..."
          git push origin HEAD:main --force

      #####################################################################
      # 13) CLEANUP
      #####################################################################
      - name: ðŸ§¹ Cleanup
        run: echo "Done."
