#!/usr/bin/env python3
"""
fetch_espn_all.py

Fix for 2025 ESPN Core API changes:
ESPN removed direct /events endpoint.
Correct structure is:

  /v2/sports/{sport}/{league}/seasons/{season}/types/{type}/events

This script:
- Auto-detects current season & type
- Fetches all events + odds
- Writes *_latest.json and combined.json
"""

import requests
import json
import datetime
import sys

OUT_COMBINED = "combined.json"

SPORTS = {
    "nfl": ("football", "nfl"),
    "ncaaf": ("football", "college-football"),
    "nba": ("basketball", "nba"),
    "ncaab": ("basketball", "mens-college-basketball"),
    "nhl": ("hockey", "nhl"),
    "mlb": ("baseball", "mlb"),
    "mma": ("mma", "ufc"),
}

SESSION = requests.Session()
SESSION.headers.update({"User-Agent": "Mozilla/5.0"})


def fetch_json(url):
    try:
        r = SESSION.get(url, timeout=10)
        r.raise_for_status()
        return r.json()
    except Exception:
        return {}


def get_current_season(sport, league):
    meta = fetch_json(f"https://sports.core.api.espn.com/v2/sports/{sport}/{league}")
    seasons = meta.get("seasons", {}).get("$ref")
    if not seasons:
        return None

    sdata = fetch_json(seasons)
    items = sdata.get("items", [])
    if not items:
        return None

    latest = items[-1]
    season = latest.get("year")
    return season


def get_current_type(sport, league, season):
    url = f"https://sports.core.api.espn.com/v2/sports/{sport}/{league}/seasons/{season}"
    meta = fetch_json(url)
    types_url = meta.get("types", {}).get("$ref")
    if not types_url:
        return 2  # default regular season

    tdata = fetch_json(types_url)
    items = tdata.get("items", [])
    if not items:
        return 2

    latest_type = items[-1].get("id", 2)
    return latest_type


def fetch_events(sport, league):
    season = get_current_season(sport, league)
    if not season:
        return []

    type_id = get_current_type(sport, league, season)

    url = (
        f"https://sports.core.api.espn.com/v2/sports/{sport}/{league}/"
        f"seasons/{season}/types/{type_id}/events"
    )
    data = fetch_json(url)

    events = data.get("items", [])
    results = []

    for item in events:
        ev = fetch_json(item.get("$ref"))
        if not ev:
            continue

        # teams
        competitions = ev.get("competitions", [])
        if not competitions:
            continue

        comp = competitions[0]
        competitors = comp.get("competitors", [])

        if len(competitors) < 2:
            continue

        home = next((t for t in competitors if t.get("homeAway") == "home"), None)
        away = next((t for t in competitors if t.get("homeAway") == "away"), None)

        if not home or not away:
            continue

        home_team = home["team"]["displayName"]
        away_team = away["team"]["displayName"]

        # spread & total — from odds section if present
        odds = comp.get("odds", [])
        spread = None
        total = None

        if odds:
            od = odds[0]
            spread = od.get("spread")
            total = od.get("overUnder")

        # favorite/team direction infer from spread
        fav_team = home_team if (spread is not None and spread < 0) else away_team
        dog_team = away_team if fav_team == home_team else home_team

        results.append({
            "sport_key": f"{sport}_{league}",
            "event_id": ev.get("id"),
            "matchup": f"{away_team}@{home_team}",
            "home_team": home_team,
            "away_team": away_team,
            "fav_team": fav_team,
            "dog_team": dog_team,
            "spread": spread,
            "total": total,
            "commence_time": ev.get("date"),
            "fetched_at": datetime.datetime.utcnow().isoformat() + "Z",
        })

    return results


def main():
    combined = {"timestamp": datetime.datetime.utcnow().strftime("%Y%m%d_%H%M"), "data": []}

    for key, (sport, league) in SPORTS.items():
        print(f"Fetching {key.upper()}...")

        games = fetch_events(sport, league)

        out_file = f"{key}_latest.json"
        with open(out_file, "w", encoding="utf-8") as f:
            json.dump({"data": games}, f, indent=2)

        print(f"✅ wrote {out_file} ({len(games)} games)")

        combined["data"].extend(games)

    with open(OUT_COMBINED, "w", encoding="utf-8") as f:
        json.dump(combined, f, indent=2)

    print(f"✅ wrote combined.json ({len(combined['data'])} total games)")


if __name__ == "__main__":
    main()
