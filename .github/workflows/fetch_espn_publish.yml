name: Auto Fetch & Publish ESPN Odds

on:
  schedule:
    - cron: "*/15 * * * *"
  workflow_dispatch:

jobs:
  fetch-and-publish:
    runs-on: ubuntu-latest

    steps:
      #####################################################################
      # 1) NUKE GITHUB WORKSPACE **BEFORE ANYTHING ELSE**
      #####################################################################
      - name: üî• Nuke GitHub Runner Workspace (Fix nested fbf-data/fbf-data)
        run: |
          echo "üî• FULL WORKSPACE NUKE"
          sudo rm -rf $GITHUB_WORKSPACE/*
          sudo rm -rf $GITHUB_WORKSPACE/.[!.]*
          sudo rm -rf $GITHUB_WORKSPACE/.??*
          echo "üî• Workspace nuked."

      #####################################################################
      # 2) CLEAN CHECKOUT ‚Äî PREVENT fbf-data/fbf-data NESTING FOREVER
      #####################################################################
      - name: üì• Checkout repository (Fresh, Clean)
        uses: actions/checkout@v4
        with:
          fetch-depth: 1
          clean: true
          path: .

      #####################################################################
      # 3) SET UP PYTHON
      #####################################################################
      - name: üêç Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: "3.11"

      #####################################################################
      # 4) INSTALL REQUIREMENTS
      #####################################################################
      - name: üì¶ Install Python dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      #####################################################################
      # 5) FETCH ESPN DATA
      #####################################################################
      - name: üì° Fetch ESPN odds‚Ä¶
        run: |
          echo "üì° Fetching ESPN odds‚Ä¶"
          python3 fetch_espn_all.py

      #####################################################################
      # 6) TAG FAVORITES
      #####################################################################
      - name: üè∑ Tag favorites
        run: python3 tag_favorites.py

      #####################################################################
      # 7) BUILD STADIUMS (FIXED)
      #####################################################################
      - name: üèü Build FBS Stadiums (correct, safe, no crash)
        run: python3 build_fbs_stadiums.py

      #####################################################################
      # 8) FETCH WEATHER & WEATHER RISK
      #####################################################################
      - name: üå¶ Fetch Weather
        run: python3 fetch_weather.py

      - name: ‚ö° Compute Weather Risk
        run: python3 weather_risk1.py

      #####################################################################
      # 9) MERGE WEATHER ONTO COMBINED DATA
      #####################################################################
      - name: üîó Merge Weather
        run: python3 merge_weather.py

      #####################################################################
      # 10) FETCH INJURIES (NON-FATAL)
      #####################################################################
      - name: ü©∫ Fetch Injuries
        run: python3 fetch_injuries.py || echo "‚ö†Ô∏è Injury fetch failed ‚Äî continuing"

      - name: üîó Merge Injuries
        run: |
          set +e
          python3 merge_injuries.py || echo "‚ö†Ô∏è Merge injuries failed ‚Äî continuing"

      #####################################################################
      # 11) HISTORICAL + TRAINING + PREDICTIONS
      #####################################################################
      - name: üßÆ Build historical results
        run: python3 build_historical_results.py || echo "‚ö†Ô∏è No historical results"

      - name: ü§ñ Train ML model
        run: python3 train_model.py || echo "‚ö†Ô∏è ML Training skipped"

      - name: üîÆ Build predictions
        run: python3 build_predictions.py

      #####################################################################
      # 12) PUSH UPDATED DATA BACK TO GITHUB PAGES
      #####################################################################
      - name: üì§ Commit & Push updated data
        run: |
          git config --global user.name "GitHub Actions"
          git config --global user.email "actions@github.com"

          git add -A
          git commit -m "Auto update data $(date -u +"%Y-%m-%d %H:%M:%S") UTC" || echo "Nothing to commit"

          # avoid push conflicts forever
          git pull --rebase --autostash || true

          git push || echo "Nothing to push"

      #####################################################################
      # 13) CLEANUP
      #####################################################################
      - name: üßπ Cleanup
        run: echo "Done."
