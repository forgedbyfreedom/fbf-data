name: Auto Fetch & Publish ESPN Odds

on:
  schedule:
    - cron: "*/15 * * * *"
  workflow_dispatch:

jobs:
  fetch-and-publish:
    runs-on: ubuntu-latest

    steps:
      #####################################################################
      # 1) CLEAN WORKSPACE ‚Äî PREVENT NESTED fbf-data/fbf-data
      #####################################################################
      - name: üß® Nuking workspace (safe)
        run: |
          echo "üß® Nuking workspace (safe)..."
          sudo rm -rf $GITHUB_WORKSPACE/*
          sudo rm -rf $GITHUB_WORKSPACE/.[!.]*
          sudo rm -rf $GITHUB_WORKSPACE/.??*

      #####################################################################
      # 2) CLEAN CHECKOUT
      #####################################################################
      - name: üì• Checkout repository cleanly
        uses: actions/checkout@v4
        with:
          fetch-depth: 1
          clean: true
          path: .

      #####################################################################
      # 3) PYTHON SETUP
      #####################################################################
      - name: üêç Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: "3.11"

      #####################################################################
      # 4) INSTALL REQUIREMENTS
      #####################################################################
      - name: üì¶ Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      #####################################################################
      # 5) FETCH ESPN LIVE ODDS
      #####################################################################
      - name: üì° Fetch ESPN odds
        run: |
          echo "üì° Fetching ESPN odds..."
          python3 fetch_espn_all.py

      #####################################################################
      # 6) TAG FAVORITES
      #####################################################################
      - name: üè∑ Tag favorites
        run: python3 tag_favorites.py

      #####################################################################
      # 7) BUILD STADIUM DATABASE
      #####################################################################
      - name: üèü Build FBS Stadiums
        run: python3 build_fbs_stadiums.py

      #####################################################################
      # 8) WEATHER FETCH + RISK
      #####################################################################
      - name: üå¶ Fetch Weather
        run: python3 fetch_weather.py

      - name: ‚ö° Compute Weather Risk
        run: python3 weather_risk1.py

      #####################################################################
      # 9) MERGE WEATHER
      #####################################################################
      - name: üîó Merge Weather
        run: python3 merge_weather.py

      #####################################################################
      # 10) INJURIES (NON-FATAL)
      #####################################################################
      - name: ü©∫ Fetch Injuries
        run: python3 fetch_injuries.py || echo "‚ö†Ô∏è Injury fetch failed ‚Äî continuing"

      - name: üîó Merge Injuries
        run: |
          set +e
          python3 merge_injuries.py || echo "‚ö†Ô∏è Injury merge failed ‚Äî continuing"

      #####################################################################
      # 11) HISTORICAL + ML + PREDICTIONS
      #####################################################################
      - name: üßÆ Build historical results
        run: python3 build_historical_results.py || echo "‚ö†Ô∏è No historical results"

      - name: ü§ñ Train ML model
        run: python3 train_model.py || echo "‚ö†Ô∏è ML Training skipped"

      - name: üîÆ Build predictions
        run: python3 build_predictions.py

      #####################################################################
      # 12) FINAL PUSH (GUARANTEED ‚Äî NO FAILS EVER)
      #####################################################################
      - name: üì§ Commit & Push updated data (absolute force)
        run: |
          echo "üìù Setting git identity..."
          git config --global user.name "GitHub Actions"
          git config --global user.email "actions@github.com"

          echo "üö´ Disabling all auto-pull/rebase behavior..."
          git config --global pull.rebase false
          git config --global pull.ff only

          echo "üì¶ Staging..."
          git add -A

          if git diff --cached --quiet; then
            echo "No changes to commit."
            exit 0
          fi

          echo "üßæ Committing..."
          git commit -m "Auto update data $(date -u +'%Y-%m-%d %H:%M:%S UTC')"

          echo "üöÄ FORCE-PUSHING SAFELY..."
          git push --force-with-lease origin main || git push --force origin main

      #####################################################################
      # 13) CLEANUP
      #####################################################################
      - name: üßπ Cleanup
        run: echo "Done."
